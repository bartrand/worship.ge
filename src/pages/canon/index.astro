---
import { Content as ComplineContent } from '../../data/canon/compline.md';
import { Content as MondayContent }   from '../../data/canon/monday.md';
import { Content as TuesdayContent }  from '../../data/canon/tuesday.md';
import { Content as WednesdayContent } from '../../data/canon/wednesday.md';
import { Content as ThursdayContent }   from '../../data/canon/thursday.md';
import { Content as ConclusionContent } from '../../data/canon/conclusion.md';

const days = ['monday', 'tuesday', 'wednesday', 'thursday'];
const dayLabels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday'];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="The Great Canon of St. Andrew of Crete" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>The Great Canon of St. Andrew of Crete | Worship.ge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap"
      rel="stylesheet"
    />
    <style is:global>
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

      :root {
        --bg:          #0f0f0f;
        --surface:     #181818;
        --border:      #2a2a2a;
        --text:        #e8e0d4;
        --text-muted:  #8a8078;
        --accent:      #b39dcc;
        --accent-dim:  #6b5080;
        --font:        'EB Garamond', Georgia, serif;
      }

      html, body {
        background: var(--bg);
        color: var(--text);
        font-family: var(--font);
        font-size: clamp(1.2rem, 4vw, 1.3rem);
        line-height: 1.75;
        min-height: 100dvh;
      }

      main {
        max-width: 680px;
        margin: 0 auto;
        padding: 2.5rem 1.25rem 5rem;
      }

      /* ── Font size control ── */
      .font-size-control {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.85rem 1.1rem;
        border-top: 1px solid var(--border);
        flex-shrink: 0;
      }

      .font-size-label {
        font-size: 0.72rem;
        letter-spacing: 0.09em;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-right: 0.35rem;
        flex-shrink: 0;
      }

      /* ── TOC one-time hint ── */
      .toc-hint {
        position: fixed;
        top: 0.4rem;
        right: 3.1rem;
        z-index: 200;
        background: var(--surface);
        border: 1px solid var(--accent-dim);
        color: var(--accent);
        font-family: var(--font);
        font-size: 0.78rem;
        letter-spacing: 0.03em;
        padding: 0.32rem 0.6rem;
        border-radius: 4px;
        white-space: nowrap;
        pointer-events: none;
        opacity: 1;
        transition: opacity 0.5s ease;
      }
      .toc-hint::after {
        content: '';
        position: absolute;
        top: 50%;
        right: -5px;
        transform: translateY(-50%);
        border: 5px solid transparent;
        border-left-color: var(--accent-dim);
        border-right: none;
      }
      .toc-hint.hidden { opacity: 0; }

      .font-size-control button {
        background: none;
        border: 1px solid var(--border);
        color: var(--text-muted);
        font-family: var(--font);
        border-radius: 4px;
        padding: 0.2rem 0.55rem;
        cursor: pointer;
        transition: border-color 0.15s, color 0.15s;
        line-height: 1;
      }

      .font-size-control button.active {
        border-color: var(--accent);
        color: var(--accent);
      }

      .font-size-control button:hover {
        border-color: var(--accent);
        color: var(--text);
      }

      html.font-small  body { font-size: clamp(1.05rem, 3.5vw, 1.15rem); }
      html.font-medium body { font-size: clamp(1.2rem,  4vw,   1.3rem);  }
      html.font-large  body { font-size: clamp(1.35rem, 5vw,   1.5rem);  }

      /* ── Page title ── */
      .canon-title {
        font-size: clamp(1.55rem, 5vw, 2.2rem);
        font-weight: 500;
        font-style: italic;
        color: var(--accent);
        text-align: center;
        letter-spacing: 0.01em;
        line-height: 1.3;
        margin-bottom: 1.25rem;
      }

      .canon-icon {
        display: block;
        margin: 0 auto 2.5rem;
        width: 100%;
        height: auto;
        opacity: 0.88;
        border-radius: 4px;
      }

      .canon-subtitle {
        text-align: center;
        font-size: 0.9rem;
        color: var(--text-muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 3rem;
      }

      /* ── Divider ── */
      .divider {
        border: none;
        border-top: 1px solid var(--border);
        margin: 2.5rem 0;
      }

      /* ── Markdown prose ── */
      .prose h1, .prose h2, .prose h3, .prose h4 {
        font-weight: 500;
        color: var(--accent);
        margin-top: 2rem;
        margin-bottom: 0.6rem;
        line-height: 1.3;
        text-align: center;
      }
      .prose h1, .prose h3, .prose h4 { font-style: italic; }
      .prose h2 { font-size: 1.4em; font-style: normal; font-variant: small-caps; letter-spacing: 0.06em; }
      .prose h1 { font-size: 1.55em; }
      .prose h3 { font-size: 1.15em; }

      .prose p {
        margin: 0;
        text-indent: 1.5em;
      }

      /* No indent on first paragraph after a heading or rule */
      .prose h1 + p, .prose h2 + p, .prose h3 + p, .prose h4 + p,
      .prose hr + p, .prose blockquote + p {
        text-indent: 0;
      }

      /* Triple line break: spaced, unindented new paragraph */
      .prose p.new-section {
        margin-top: 1.25em;
        text-indent: 0;
      }

      .prose strong {
        font-weight: 400;
        font-size: 0.7em;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--accent);
      }

      .prose em {
        font-style: italic;
        color: var(--text);
      }

      .prose blockquote {
        border-left: 2px solid var(--accent-dim);
        padding-left: 1.1rem;
        color: var(--text-muted);
        font-style: italic;
        margin: 1.25rem 0;
      }

      .prose ul, .prose ol {
        padding-left: 1.4rem;
        margin-bottom: 1rem;
      }

      .prose li { margin-bottom: 0.3rem; }

      .prose hr {
        border: none;
        border-top: 1px solid var(--border);
        margin: 2rem 0;
      }

      .prose a {
        color: var(--accent);
        text-decoration: underline;
        text-underline-offset: 3px;
      }

      /* ── Day chooser ── */
      .day-chooser-wrap {
        margin: 2rem 0 1.5rem;
      }

      .day-chooser-label {
        text-align: center;
        font-size: 0.8rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
      }

      .day-chooser {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
      }

      .day-chooser button {
        background: none;
        border: 1px solid var(--border);
        color: var(--accent);
        font-family: var(--font);
        font-size: 1.4rem;
        line-height: 1;
        width: 2.4rem;
        height: 2.4rem;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: border-color 0.15s, background 0.15s;
        flex-shrink: 0;
      }

      .day-chooser button:hover {
        background: var(--surface);
        border-color: var(--accent-dim);
      }

      .day-chooser button:disabled {
        opacity: 0.25;
        cursor: default;
      }

      #day-label {
        font-size: clamp(1.2rem, 4vw, 1.5rem);
        font-style: italic;
        color: var(--text);
        min-width: 9rem;
        text-align: center;
        letter-spacing: 0.01em;
      }

      /* ── Day content ── */
      .day-content { display: none; }
      .day-content.active { display: block; }

      /* ── TOC button ── */
      .toc-btn {
        position: fixed;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 200;
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--accent);
        font-family: var(--font);
        font-size: 1.1rem;
        width: 2.4rem;
        height: 2.4rem;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: border-color 0.15s, background 0.15s;
        line-height: 1;
      }
      .toc-btn:hover { background: #222; border-color: var(--accent); }

      /* ── TOC drawer ── */
      .toc-drawer {
        position: fixed;
        top: 0; right: 0;
        height: 100dvh;
        width: min(320px, 85vw);
        background: var(--surface);
        border-left: 1px solid var(--border);
        z-index: 300;
        transform: translateX(100%);
        transition: transform 0.25s ease;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .toc-drawer.open { transform: translateX(0); }

      .toc-drawer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.1rem 0.75rem;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }
      .toc-drawer-header span {
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      .toc-close {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 1.3rem;
        cursor: pointer;
        line-height: 1;
        padding: 0.2rem;
      }
      .toc-close:hover { color: var(--text); }

      .toc-list {
        overflow-y: auto;
        padding: 0.75rem 0 2rem;
        flex: 1;
      }
      .toc-list a {
        display: block;
        padding: 0.45rem 1.1rem;
        color: var(--text);
        text-decoration: none;
        font-size: 0.95rem;
        line-height: 1.3;
        border-left: 2px solid transparent;
        transition: color 0.1s, border-color 0.1s;
      }
      .toc-list a:hover { color: var(--accent); border-left-color: var(--accent); }
      .toc-list a.toc-h3 { padding-left: 2rem; font-size: 0.85rem; color: var(--text-muted); }
      .toc-list a.toc-h3:hover { color: var(--accent); }

      .toc-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 250;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s;
      }
      .toc-overlay.open { opacity: 1; pointer-events: all; }
    </style>
  </head>

  <body>
    <main>
      <!-- Font size control is now inside the TOC drawer -->

      <h1 class="canon-title">The Great Canon<br/>of St. Andrew of Crete</h1>
      <img src="/st-andrew-of-crete.jpg" alt="Icon of St. Andrew of Crete" class="canon-icon" />

      <!-- Compline -->
      <section class="prose" id="section-compline">
        <ComplineContent />
      </section>

      <hr class="divider" />

      <!-- Day chooser -->
      <div class="day-chooser-wrap">
        <p class="day-chooser-label">Select day</p>
        <div class="day-chooser">
          <button id="prev-day" aria-label="Previous day">&#8592;</button>
          <span id="day-label">Monday</span>
          <button id="next-day" aria-label="Next day">&#8594;</button>
        </div>
      </div>

      <!-- Day contents (all pre-rendered, toggled by JS) -->
      <section class="day-content prose" id="day-monday">
        <MondayContent />
      </section>
      <section class="day-content prose" id="day-tuesday">
        <TuesdayContent />
      </section>
      <section class="day-content prose" id="day-wednesday">
        <WednesdayContent />
      </section>
      <section class="day-content prose" id="day-thursday">
        <ThursdayContent />
      </section>

      <hr class="divider" />

      <section class="prose" id="section-conclusion">
        <ConclusionContent />
      </section>
    </main>

    <!-- TOC button -->
    <button class="toc-btn" id="toc-btn" aria-label="Table of contents">☰</button>
    <div class="toc-hint" id="toc-hint">Contents &amp; text size</div>

    <!-- TOC overlay -->
    <div class="toc-overlay" id="toc-overlay"></div>

    <!-- TOC drawer -->
    <nav class="toc-drawer" id="toc-drawer" aria-label="Table of contents">
      <div class="toc-drawer-header">
        <span>Contents</span>
        <button class="toc-close" id="toc-close" aria-label="Close">&times;</button>
      </div>
      <div class="toc-list" id="toc-list"></div>
      <div class="font-size-control" aria-label="Font size">
        <span class="font-size-label">Text size</span>
        <button data-size="font-small"  aria-label="Small text">A</button>
        <button data-size="font-medium" aria-label="Medium text" style="font-size:1.15em">A</button>
        <button data-size="font-large"  aria-label="Large text"  style="font-size:1.35em">A</button>
      </div>
    </nav>

    <script>
      // ── Font size ───────────────────────────────────────────────
      const SIZE_KEY = 'canon-font-size';

      function applySize(size: string) {
        const html = document.documentElement;
        html.classList.remove('font-small', 'font-medium', 'font-large');
        html.classList.add(size);
        localStorage.setItem(SIZE_KEY, size);
        document.querySelectorAll<HTMLButtonElement>('[data-size]').forEach(b => {
          b.classList.toggle('active', b.dataset.size === size);
        });
      }

      const sizeButtons = document.querySelectorAll<HTMLButtonElement>('[data-size]');
      sizeButtons.forEach(b => b.addEventListener('click', () => applySize(b.dataset.size!)));
      applySize(localStorage.getItem(SIZE_KEY) || 'font-medium');

      // ── Day chooser ────────────────────────────────────────────
      const days = ['monday', 'tuesday', 'wednesday', 'thursday'];
      const dayLabels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday'];

      // Determine current day in Tbilisi time (UTC+4, no DST)
      function getTbilisiDayIndex(): number {
        const now = new Date();
        const utcMs = now.getTime() + now.getTimezoneOffset() * 60_000;
        const tbilisi = new Date(utcMs + 4 * 3_600_000);
        const dow = tbilisi.getDay(); // 0=Sun 1=Mon 2=Tue 3=Wed 4=Thu 5=Fri 6=Sat
        if (dow >= 1 && dow <= 4) return dow - 1; // map Mon=0 … Thu=3
        return 0; // default: Monday
      }

      let current = getTbilisiDayIndex();

      const labelEl   = document.getElementById('day-label')!;
      const prevBtn   = document.getElementById('prev-day') as HTMLButtonElement;
      const nextBtn   = document.getElementById('next-day') as HTMLButtonElement;
      const sections  = days.map(d => document.getElementById(`day-${d}`)!);

      function render() {
        sections.forEach((s, i) => s.classList.toggle('active', i === current));
        labelEl.textContent = dayLabels[current];
        prevBtn.disabled = current === 0;
        nextBtn.disabled = current === days.length - 1;
      }

      prevBtn.addEventListener('click', () => { if (current > 0) { current--; render(); buildToc(); } });
      nextBtn.addEventListener('click', () => { if (current < days.length - 1) { current++; render(); buildToc(); } });

      render();

      // ── TOC ────────────────────────────────────────────────
      const tocBtn     = document.getElementById('toc-btn')!;
      const tocDrawer  = document.getElementById('toc-drawer')!;
      const tocOverlay = document.getElementById('toc-overlay')!;
      const tocClose   = document.getElementById('toc-close')!;
      const tocList    = document.getElementById('toc-list')!;
      const tocHint    = document.getElementById('toc-hint')!;

      const HINT_KEY = 'canon-toc-hint-seen';
      if (localStorage.getItem(HINT_KEY)) tocHint.classList.add('hidden');

      function openToc() {
        tocDrawer.classList.add('open');
        tocOverlay.classList.add('open');
        if (!localStorage.getItem(HINT_KEY)) {
          localStorage.setItem(HINT_KEY, '1');
          tocHint.classList.add('hidden');
        }
      }
      function closeToc() { tocDrawer.classList.remove('open'); tocOverlay.classList.remove('open'); }

      tocBtn.addEventListener('click', openToc);
      tocClose.addEventListener('click', closeToc);
      tocOverlay.addEventListener('click', closeToc);

      // Auto-add IDs to headings so we can link to them
      let headingIdx = 0;
      document.querySelectorAll('.prose h1, .prose h2, .prose h3').forEach(h => {
        if (!h.id) h.id = 'h-' + (headingIdx++);
      });

      function buildToc() {
        tocList.innerHTML = '';
        // Always include compline headings
        const compline = document.querySelector('#section-compline');
        const activeDay = sections.find(s => s.classList.contains('active'));
        const conclusion = document.querySelector('#section-conclusion');

        [compline, activeDay, conclusion].forEach(section => {
          if (!section) return;
          section.querySelectorAll('h1, h2').forEach(h => {
            if (!h.textContent?.trim()) return;
            const a = document.createElement('a');
            a.href = '#' + h.id;
            a.textContent = h.textContent!.trim();
            a.className = 'toc-' + h.tagName.toLowerCase();
            a.addEventListener('click', () => closeToc());
            tocList.appendChild(a);
          });
        });
      }

      buildToc();
    </script>
  </body>
</html>
