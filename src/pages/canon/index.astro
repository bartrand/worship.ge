---
import { Content as ComplineContent } from '../../data/canon/compline.md';
import { Content as MondayContent }   from '../../data/canon/monday.md';
import { Content as TuesdayContent }  from '../../data/canon/tuesday.md';
import { Content as WednesdayContent } from '../../data/canon/wednesday.md';
import { Content as ThursdayContent }   from '../../data/canon/thursday.md';
import { Content as ConclusionContent } from '../../data/canon/conclusion.md';
import { Content as Week5Content }      from '../../data/canon/week5.md';

const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'week5'];
const dayLabels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Week V'];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="The Great Canon of St. Andrew of Crete" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>The Great Canon of St. Andrew of Crete | Worship.ge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap"
      rel="stylesheet"
    />
    <style is:global>
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

      :root {
        --bg:          #0f0f0f;
        --surface:     #181818;
        --border:      #2a2a2a;
        --text:        #e8e0d4;
        --text-muted:  #8a8078;
        --accent:      #b39dcc;
        --accent-dim:  #6b5080;
        --font:        'EB Garamond', Georgia, serif;
        --fs:          1.2;
      }

      html, body {
        background: var(--bg);
        color: var(--text);
        font-family: var(--font);
        font-size: calc(var(--fs) * 1rem);
        line-height: 1.75;
        min-height: 100dvh;
      }

      main {
        max-width: 680px;
        margin: 0 auto;
        padding: 2.5rem 1.25rem 5rem;
      }


      /* ── Page title ── */
      .canon-title {
        font-size: clamp(1.55rem, 5vw, 2.2rem);
        font-weight: 500;
        font-style: italic;
        color: var(--accent);
        text-align: center;
        letter-spacing: 0.01em;
        line-height: 1.3;
        margin-bottom: 1.25rem;
      }

      .canon-icon {
        display: block;
        margin: 0 auto 2.5rem;
        width: 100%;
        height: auto;
        opacity: 0.88;
        border-radius: 4px;
      }

      .canon-subtitle {
        text-align: center;
        font-size: 0.9rem;
        color: var(--text-muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 3rem;
      }

      /* ── Divider ── */
      .divider {
        border: none;
        border-top: 1px solid var(--border);
        margin: 2.5rem 0;
      }

      /* ── Markdown prose ── */
      .prose h1, .prose h2, .prose h3, .prose h4 {
        font-weight: 500;
        color: var(--accent);
        margin-top: 2rem;
        margin-bottom: 0.6rem;
        line-height: 1.3;
        text-align: center;
      }
      .prose h1, .prose h3, .prose h4 { font-style: italic; }
      .prose h2 { font-size: 1.4em; font-style: normal; font-variant: small-caps; letter-spacing: 0.06em; }
      .prose h1 { font-size: 1.55em; }
      .prose h3 { font-size: 1.15em; }

      .prose p {
        margin: 0;
        text-indent: 1.5em;
      }

      /* No indent on first paragraph after a heading or rule */
      .prose h1 + p, .prose h2 + p, .prose h3 + p, .prose h4 + p,
      .prose hr + p, .prose blockquote + p {
        text-indent: 0;
      }

      /* Triple line break: spaced, unindented new paragraph */
      .prose p.new-section {
        margin-top: 1.25em;
        text-indent: 0;
      }

      .prose strong {
        font-weight: 400;
        font-size: 0.7em;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--accent);
      }

      .prose em {
        font-style: italic;
        color: var(--text);
      }

      .prose blockquote {
        border-left: 2px solid var(--accent-dim);
        padding-left: 1.1rem;
        color: var(--text-muted);
        font-style: italic;
        margin: 1.25rem 0;
      }

      .prose ul, .prose ol {
        padding-left: 1.4rem;
        margin-bottom: 1rem;
      }

      .prose li { margin-bottom: 0.3rem; }

      .prose hr {
        border: none;
        border-top: 1px solid var(--border);
        margin: 2rem 0;
      }

      .prose a {
        color: var(--accent);
        text-decoration: underline;
        text-underline-offset: 3px;
      }

      /* ── Day chooser ── */
      .day-chooser-wrap {
        margin: 2rem 0 1.5rem;
      }

      .day-chooser-label {
        text-align: center;
        font-size: 0.8rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
      }

      .day-chooser {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
      }

      .day-chooser button {
        background: none;
        border: 1px solid var(--border);
        color: var(--accent);
        font-family: var(--font);
        font-size: 1.4rem;
        line-height: 1;
        width: 2.4rem;
        height: 2.4rem;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: border-color 0.15s, background 0.15s;
        flex-shrink: 0;
      }

      .day-chooser button:hover {
        background: var(--surface);
        border-color: var(--accent-dim);
      }

      .day-chooser button:disabled {
        opacity: 0.25;
        cursor: default;
      }

      #day-label {
        font-size: clamp(1.2rem, 4vw, 1.5rem);
        font-style: italic;
        color: var(--text);
        min-width: 9rem;
        text-align: center;
        letter-spacing: 0.01em;
      }

      /* ── Day content ── */
      .day-content { display: none; }
      .day-content.active { display: block; }

      /* ── Font size button ── */
      .fs-btn {
        position: fixed;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 200;
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--accent);
        font-family: var(--font);
        font-size: 1.05rem;
        font-style: italic;
        width: 2.4rem;
        height: 2.4rem;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: border-color 0.15s, background 0.15s;
        line-height: 1;
      }
      .fs-btn:hover { background: #222; border-color: var(--accent); }
      .fs-btn.open  { border-color: var(--accent); background: #222; }

      /* ── Font size popup ── */
      .fs-popup {
        position: fixed;
        top: 3.3rem;
        right: 0.5rem;
        z-index: 200;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.7rem 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.65rem;
        opacity: 0;
        pointer-events: none;
        transform: translateY(-6px);
        transition: opacity 0.15s ease, transform 0.15s ease;
        box-shadow: 0 6px 20px rgba(0,0,0,0.5);
      }
      .fs-popup.open {
        opacity: 1;
        pointer-events: all;
        transform: translateY(0);
      }
      .fs-size-btn {
        background: none;
        border: 1px solid var(--border);
        color: var(--text-muted);
        font-family: var(--font);
        border-radius: 4px;
        padding: 0.2rem 0.55rem;
        cursor: pointer;
        transition: border-color 0.15s, color 0.15s;
        line-height: 1;
      }
      .fs-size-btn.active {
        border-color: var(--accent);
        color: var(--accent);
      }
      .fs-size-btn:hover {
        border-color: var(--accent);
        color: var(--text);
      }

      /* ── Section nav bar ── */
      .sec-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        padding: 0 0.75rem;
        height: 3.25rem;
        background: var(--surface);
        border-top: 1px solid var(--border);
      }

      .sec-bar-btn {
        background: none;
        border: 1px solid var(--accent-dim);
        color: var(--accent);
        font-family: var(--font);
        font-size: 1.3rem;
        width: 2.2rem;
        height: 2.2rem;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: border-color 0.15s, background 0.15s;
        line-height: 1;
      }
      .sec-bar-btn:hover:not(:disabled) { background: var(--bg); border-color: var(--accent); }
      .sec-bar-btn:disabled { opacity: 0.2; cursor: default; }

      .sec-bar-label {
        flex: 1;
        text-align: center;
        font-variant: small-caps;
        font-style: normal;
        font-size: clamp(0.95rem, 3vw, 1.1rem);
        color: var(--text);
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        letter-spacing: 0.06em;
      }
    </style>
  </head>

  <body>
    <main>
      <h1 class="canon-title">The Great Canon<br/>of St. Andrew of Crete</h1>
      <img src="/st-andrew-of-crete.jpg" alt="Icon of St. Andrew of Crete" class="canon-icon" />

      <!-- Compline -->
      <section class="prose" id="section-compline">
        <ComplineContent />
      </section>

      <hr class="divider" />

      <!-- Day chooser -->
      <div class="day-chooser-wrap">
        <p class="day-chooser-label">Select day</p>
        <div class="day-chooser">
          <button id="prev-day" aria-label="Previous day">&#8592;</button>
          <span id="day-label">Monday</span>
          <button id="next-day" aria-label="Next day">&#8594;</button>
        </div>
      </div>

      <!-- Day contents (all pre-rendered, toggled by JS) -->
      <section class="day-content prose" id="day-monday">
        <MondayContent />
      </section>
      <section class="day-content prose" id="day-tuesday">
        <TuesdayContent />
      </section>
      <section class="day-content prose" id="day-wednesday">
        <WednesdayContent />
      </section>
      <section class="day-content prose" id="day-thursday">
        <ThursdayContent />
      </section>
      <section class="day-content prose" id="day-week5">
        <Week5Content />
      </section>

      <hr class="divider" />

      <section class="prose" id="section-conclusion">
        <ConclusionContent />
      </section>
    </main>

    <!-- Section nav bar -->
    <div class="sec-bar" id="sec-bar" aria-label="Section navigation">
      <button class="sec-bar-btn" id="sec-prev" aria-label="Previous section">&#8592;</button>
      <span class="sec-bar-label" id="sec-label"></span>
      <button class="sec-bar-btn" id="sec-next" aria-label="Next section">&#8594;</button>
    </div>

    <!-- Font size button + popup -->
    <button class="fs-btn" id="fs-btn" aria-label="Text size" aria-expanded="false">A</button>
    <div class="fs-popup" id="fs-popup" role="dialog" aria-label="Text size">
      <button class="fs-size-btn" data-size="1.05" aria-label="Small text">A</button>
      <button class="fs-size-btn" data-size="1.2"  aria-label="Medium text" style="font-size:1.15em">A</button>
      <button class="fs-size-btn" data-size="1.4"  aria-label="Large text"  style="font-size:1.35em">A</button>
    </div>

    <script>
      // ── Font size ────────────────────────────────────────────
      const FS_KEY     = 'canon-font-size-v2';
      const FS_DEFAULT = '1.2';
      const fsBtn      = document.getElementById('fs-btn') as HTMLButtonElement;
      const fsPopup    = document.getElementById('fs-popup')!;
      const fsSizeBtns = document.querySelectorAll<HTMLButtonElement>('.fs-size-btn');

      function applySize(val: string) {
        document.documentElement.style.setProperty('--fs', val);
        localStorage.setItem(FS_KEY, val);
        fsSizeBtns.forEach(b => b.classList.toggle('active', b.dataset.size === val));
      }

      fsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = fsPopup.classList.toggle('open');
        fsBtn.classList.toggle('open', isOpen);
        fsBtn.setAttribute('aria-expanded', String(isOpen));
      });

      document.addEventListener('click', (e) => {
        if (!fsPopup.contains(e.target as Node) && e.target !== fsBtn) {
          fsPopup.classList.remove('open');
          fsBtn.classList.remove('open');
          fsBtn.setAttribute('aria-expanded', 'false');
        }
      });

      fsSizeBtns.forEach(b => b.addEventListener('click', () => {
        applySize(b.dataset.size!);
        fsPopup.classList.remove('open');
        fsBtn.classList.remove('open');
        fsBtn.setAttribute('aria-expanded', 'false');
      }));

      applySize(localStorage.getItem(FS_KEY) ?? FS_DEFAULT);

      // ── Day chooser ────────────────────────────────────────────
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'week5'];
      const dayLabels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Week V'];

      // Determine current day in Tbilisi time (UTC+4, no DST)
      function getTbilisiDayIndex(): number {
        const now = new Date();
        const utcMs = now.getTime() + now.getTimezoneOffset() * 60_000;
        const tbilisi = new Date(utcMs + 4 * 3_600_000);
        const dow = tbilisi.getDay(); // 0=Sun 1=Mon 2=Tue 3=Wed 4=Thu 5=Fri 6=Sat
        if (dow >= 1 && dow <= 4) return dow - 1; // map Mon=0 … Thu=3
        return 0; // default: Monday
      }

      let current = getTbilisiDayIndex();

      const labelEl   = document.getElementById('day-label')!;
      const prevBtn   = document.getElementById('prev-day') as HTMLButtonElement;
      const nextBtn   = document.getElementById('next-day') as HTMLButtonElement;
      const sections  = days.map(d => document.getElementById(`day-${d}`)!);

      function render() {
        sections.forEach((s, i) => s.classList.toggle('active', i === current));
        labelEl.textContent = dayLabels[current];
        prevBtn.disabled = current === 0;
        nextBtn.disabled = current === days.length - 1;
      }

      prevBtn.addEventListener('click', () => { if (current > 0) { current--; render(); buildSecNav(); } });
      nextBtn.addEventListener('click', () => { if (current < days.length - 1) { current++; render(); buildSecNav(); } });

      render();

      // ── Section nav bar ────────────────────────────────────────
      const secBar   = document.getElementById('sec-bar')!;
      const secLabel = document.getElementById('sec-label')!;
      const secPrev  = document.getElementById('sec-prev') as HTMLButtonElement;
      const secNext  = document.getElementById('sec-next') as HTMLButtonElement;

      let secHeadings: HTMLElement[] = [];
      let currentSecIdx = 0;

      function buildSecNav() {
        const compline   = document.querySelector('#section-compline')!;
        const activeDay  = sections.find(s => s.classList.contains('active'))!;
        const conclusion = document.querySelector('#section-conclusion')!;
        secHeadings = [];
        [compline, activeDay, conclusion].forEach(sec => {
          if (!sec) return;
          sec.querySelectorAll<HTMLElement>('h2').forEach(h => secHeadings.push(h));
        });
        updateSecBar();
      }

      function getCurrentSecIdx(): number {
        // The current section is the last h2 whose top is at or above 40% of the viewport
        const threshold = window.scrollY + window.innerHeight * 0.4;
        let idx = 0;
        for (let i = 0; i < secHeadings.length; i++) {
          if (secHeadings[i].getBoundingClientRect().top + window.scrollY <= threshold) {
            idx = i;
          }
        }
        return idx;
      }

      function updateSecBar() {
        if (secHeadings.length === 0) return;
        currentSecIdx = getCurrentSecIdx();
        secLabel.textContent = secHeadings[currentSecIdx].textContent?.trim() ?? '';
        secPrev.disabled = currentSecIdx === 0;
        secNext.disabled = currentSecIdx === secHeadings.length - 1;
      }

      function scrollToSec(idx: number) {
        if (idx < 0 || idx >= secHeadings.length) return;
        secHeadings[idx].scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Optimistically update label while smooth scroll is in progress
        currentSecIdx = idx;
        secLabel.textContent = secHeadings[idx].textContent?.trim() ?? '';
        secPrev.disabled = idx === 0;
        secNext.disabled = idx === secHeadings.length - 1;
      }

      secPrev.addEventListener('click', () => scrollToSec(currentSecIdx - 1));
      secNext.addEventListener('click', () => scrollToSec(currentSecIdx + 1));
      window.addEventListener('scroll', updateSecBar, { passive: true });

      buildSecNav();
    </script>
  </body>
</html>
